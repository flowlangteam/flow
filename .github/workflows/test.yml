name: Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test-rust:
    name: Rust Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        components: rustfmt, clippy

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/
          ~/.cargo/git/
          flow_c/target/
        key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}

    - name: Check formatting
      working-directory: flow_c
      run: cargo fmt --all -- --check
      continue-on-error: true

    - name: Clippy
      working-directory: flow_c
      run: cargo clippy --workspace -- -D warnings
      continue-on-error: true

    - name: Run unit tests
      working-directory: flow_c
      run: cargo test --workspace --lib

    - name: Run integration tests
      working-directory: flow_c
      run: cargo test --workspace --test '*'

    - name: Run doc tests
      working-directory: flow_c
      run: cargo test --workspace --doc

  test-codegen:
    name: Codegen Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/
          ~/.cargo/git/
          flow_c/target/
        key: ${{ runner.os }}-codegen-${{ hashFiles('**/Cargo.lock') }}

    - name: Test codegen
      working-directory: flow_c
      run: cargo test -p flow_codegen -- --test-threads=1 --nocapture

  test-transpiler:
    name: Transpiler Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/
          ~/.cargo/git/
          flow_c/target/
        key: ${{ runner.os }}-transpiler-${{ hashFiles('**/Cargo.lock') }}

    - name: Test Java transpiler
      working-directory: flow_c
      run: cargo test -p flow_transpiler_java -- --nocapture

    - name: Build CLI
      working-directory: flow_c
      run: cargo build --release -p flow_cli

    - name: Test transpilation
      run: |
        cat > test.flow << 'EOF'
        func fibonacci(n: Int) -> Int {
            if n <= 1 {
                n
            } else {
                fibonacci(n - 1) + fibonacci(n - 2)
            }
        }
        EOF
        
        ./flow_c/target/release/flow transpile --target java test.flow
        javap -c Test.class
        rm test.flow Test.class

  test-jni:
    name: JNI Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/
          ~/.cargo/git/
          flow_c/target/
        key: ${{ runner.os }}-jni-${{ hashFiles('**/Cargo.lock') }}

    - name: Build JNI library
      working-directory: flow_c
      run: cargo build --release -p flow_jni

    - name: Test JNI library
      working-directory: flow_c
      run: cargo test -p flow_jni

  test-examples:
    name: Example Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/
          ~/.cargo/git/
          flow_c/target/
        key: ${{ runner.os }}-examples-${{ hashFiles('**/Cargo.lock') }}

    - name: Build CLI
      working-directory: flow_c
      run: cargo build --release -p flow_cli

    - name: Test examples compile
      working-directory: flow_c
      run: |
        for example in examples/*.flow; do
          echo "Testing $example"
          ../flow_c/target/release/flow transpile --target java "$example" || true
        done

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Install cargo-tarpaulin
      run: cargo install cargo-tarpaulin

    - name: Cache Cargo
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/
          ~/.cargo/git/
          flow_c/target/
        key: ${{ runner.os }}-coverage-${{ hashFiles('**/Cargo.lock') }}

    - name: Generate coverage
      working-directory: flow_c
      run: cargo tarpaulin --workspace --timeout 300 --out Xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./flow_c/cobertura.xml
        fail_ci_if_error: false
